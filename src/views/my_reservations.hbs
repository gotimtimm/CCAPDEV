<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <title>My Reservations</title>
</head>

<body class="bg-light">
  
  <section id="my" class="container my-5">
    <h3 class="mb-4">My Reservations</h3>
    <div id="bookingsList" class="list-group shadow-sm">
      {{#if reservations}}
        {{#each reservations}}
          <div class="list-group-item list-group-item-action flex-column align-items-start {{#if (eq this.status 'Cancelled')}}list-group-item-danger{{/if}}">
            
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">
                 {{this.flight.airlineName}} {{this.flight.flightNumber}}
                 <span class="text-muted fs-6">({{this.flight.origin}} &rarr; {{this.flight.destination}})</span>
              </h5>
              <small class="text-muted">Date: {{this.reservedDate}}</small>
            </div>

            <div class="mt-2">
                <p class="mb-1">
                    <strong>Passenger:</strong> {{this.fullName}} | 
                    <strong>Seat:</strong> {{this.selectedSeat}} | 
                    <strong>Price:</strong> ₱{{this.totalPrice}}
                </p>

                <div class="mt-2 mb-2">
                    {{#if (eq this.status 'Cancelled')}}
                        <span class="badge bg-danger">Cancelled</span>
                    {{else}}
                        {{#if this.isCheckedIn}}
                            <span class="badge bg-success">✅ Checked In</span>
                            <span class="badge bg-secondary">BP: {{this.boardingPassNumber}}</span>
                        {{else}}
                            <span class="badge bg-warning text-dark">Booked</span>
                            <span class="badge bg-info text-dark">Ref: {{this.pnr}}</span> <a href="/checkin" class="btn btn-sm btn-primary ms-2" style="padding: 2px 10px; font-size: 12px;">
                                Online Check-in &rarr;
                            </a>
                        {{/if}}
                    {{/if}}
                </div>
                </div>

            {{#unless (eq this.status 'Cancelled')}}
            <button class="btn btn-sm btn-outline-secondary mt-2"
                 data-bs-toggle="modal" 
                 data-bs-target="#bookingModal"
                 data-id="{{this._id}}" 
                 data-full-name="{{this.fullName}}"
                 data-email="{{this.email}}"
                 data-seat="{{this.selectedSeat}}"
                 data-meal="{{this.mealOption}}"
                 data-baggage="{{this.extraBaggage}}"
                 data-date="{{this.reservedDate}}"
                 data-price="{{this.totalPrice}}"
                 data-flight-id="{{this.flight._id}}"
                 data-base-price="{{this.flight.basePrice}}"
                 data-status="{{this.status}}"
                 data-flight-route="{{this.flight.origin}} &rarr; {{this.flight.destination}}">
                 Manage Booking (Edit/Cancel)
            </button>
            {{/unless}}

          </div>
        {{/each}}
      {{else}}
        <div class="list-group-item">No reservations found.</div>
      {{/if}}
    </div>
  </section>
  
  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Reservation: <span id="modalBookingId"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          
          <div class="mb-3">
              <p><strong>Flight:</strong> <span id="modalFlightDetails"></span></p>
              <p><strong>Passenger:</strong> <span id="modalPassengerDetails"></span></p>
              <p><strong>Date:</strong> <span id="modalReservedDate"></span></p>
              <hr>
          </div>

          <form id="editReservationForm" method="POST">
            <input type="hidden" id="editFlightBasePrice">
            
            <div id="editableContent">
                <h6 class="fw-bold">Modify Options</h6>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="editSelectedSeat" class="form-label">Seat Selection</label>
                        <input type="text" class="form-control" id="editSelectedSeat" name="selectedSeat" required>
                        <small class="text-muted">Enter new seat (e.g., A1, B10).</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editMeal" class="form-label">Meal Option</label>
                        <select id="editMeal" name="mealOption" class="form-select">
                            <option value="0">Chips (PHP 0)</option>
                            <option value="150">Mixed Vegetables with Mashed Potato (PHP 150)</option>
                            <option value="270">Sausage with Hashbrown (PHP 270)</option>
                            <option value="320">Hainanese Soy Chicken with Brown Rice(PHP 320)</option>
                            <option value="360">Chives Dumpling with Japanese Gyudon (PHP 360)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editBaggage" class="form-label">Extra Baggage Weight (KG)</label>
                        <select id="editBaggage" name="extraBaggage" class="form-select">
                            <option value="2">2 kg (Free)</option>
                            <option value="5">5 kg (₱500)</option>
                            <option value="10">10 kg (₱1,000)</option>
                            <option value="15">15 kg (₱1,500)</option>
                            <option value="20">20 kg (₱2,000)</option>
                        </select>
                    </div>
                </div>
                
                <div class="summary-box alert alert-info">
                    <h6 class="fw-bold">New Total: <span id="editTotalSummary">₱0</span></h6>
                    <input type="hidden" id="editTotalPriceHidden" name="totalPrice">
                </div>

                <button type="submit" class="btn btn-success w-100 mt-3">Save Changes</button>
            </div>
          </form>

          <hr>
          <form id="cancelReservationForm" method="POST">
              <button type="submit" class="btn btn-danger w-100 mt-3" id="cancelButton">Cancel Reservation</button>
          </form>
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    $(document).ready(function() {
      // Define baggage tiers for pricing calculation
      const baggageTiers = [
        { weight: 2, cost: 0 },
        { weight: 5, cost: 500 },
        { weight: 10, cost: 1000 },
        { weight: 15, cost: 1500 },
        { weight: 20, cost: 2000 }
      ];

      // --- Dynamic Price Update Logic for Edit Modal ---
      function updateEditSummary() {
        let baseFare = parseInt($("#editFlightBasePrice").val()) || 0;
        let mealCost = parseInt($("#editMeal").val()) || 0;
        
        let selectedWeightKg = parseInt($("#editBaggage").val());
        let baggageCost = baggageTiers.find(tier => tier.weight === selectedWeightKg)?.cost || 0;
        
        let total = baseFare + mealCost + baggageCost;

        $("#editTotalSummary").text(`₱${total}`);
        $("#editTotalPriceHidden").val(total);
      }

      $("#editMeal, #editBaggage, #editSelectedSeat").on("change keyup", updateEditSummary);

      // --- Modal Logic to Load Data ---
      $('#bookingModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        
        // Extract data
        const id = button.data('id');
        const fullName = button.data('full-name');
        const email = button.data('email');
        const basePrice = button.data('base-price');
        const flightRoute = button.data('flight-route');

        const currentSeat = button.data('seat');
        const currentMeal = button.data('meal');
        const currentBaggageKg = button.data('baggage'); 
        const currentDate = button.data('date');

        // Populate modal content
        $("#modalBookingId").text(id);
        $("#modalFlightDetails").html(flightRoute);
        $("#modalPassengerDetails").text(fullName + ' (' + email + ')');
        $("#modalReservedDate").text(currentDate); 
        
        // Set form action URLs
        $("#editReservationForm").attr('action', '/my-reservations/update/' + id);
        $("#cancelReservationForm").attr('action', '/my-reservations/cancel/' + id);

        // Populate form fields
        $("#editSelectedSeat").val(currentSeat);
        $("#editMeal").val(currentMeal).trigger('change');
        $("#editBaggage").val(currentBaggageKg).trigger('change'); 
        
        $("#editFlightBasePrice").val(basePrice);
        updateEditSummary();
      });
      
      // FIX: Confirmation dialog and submission for cancellation
      $("#cancelReservationForm").submit(function(e) {
        if (!confirm("Are you sure you want to cancel this reservation? This action cannot be undone.")) {
            e.preventDefault();
            return false;
        }
        // If confirmed, the form submits the POST request to /my-reservations/cancel/:id
      });
    });
  </script>
</body>
</html>
