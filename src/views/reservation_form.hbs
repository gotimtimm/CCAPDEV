<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <title>Flight Reservation</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: url("/images/elnido.jpg"); 
      background-size: cover;
      margin: 0; padding: 0px;
    }
    .content-container {
      max-width: 1250px; margin: 50px auto 0 auto;  
      background: #ffffff; padding: 50px; border-radius: 50px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #007bff; margin-bottom: 50px; margin-top: -20px; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select {
      width: 100%; padding: 8px; border-radius: 8px;
      border: 1px solid #ccc; margin-bottom: 10px; margin-top: 10px; font-size: 14px;
    }
    /* Seat Map Styles */
    .seat-map {
      display: flex; flex-direction: column; align-items: center;
      gap: 8px; margin: 25px 0; padding: 20px;
      background: #f0f0f0; border-radius: 30px 30px 100px 100px;
      border: 4px solid #ddd; width: fit-content; margin-left: auto; margin-right: auto;
    }
    .seat-row { display: flex; gap: 5px; align-items: center; }
    .seat {
      width: 40px; height: 40px; background: #e0e0e0;
      text-align: center; line-height: 40px; border-radius: 8px;
      cursor: pointer; font-size: 12px; font-weight: bold; color: #555;
      border-bottom: 4px solid #bbb;
    }
    .seat.selected { background: #28a745; color: white; border-color: #1e7e34; }
    .seat.occupied { background: #dc3545; color: white; cursor: not-allowed; border-color: #a71d2a; }
    .aisle-number { width: 30px; text-align: center; font-size: 10px; color: #aaa; font-weight: bold; }
    .aisle-spacer { width: 30px; }
    .summary-box { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px; }
    .btn-action {
      padding: 10px; border: none; border-radius: 8px; font-size: 16px;
      cursor: pointer; margin-top: 10px; color: white; width: 100%;
    }
    .btn-submit { background: #007bff; margin-top: 30px; margin-bottom: 20px; }
    .btn-back { background: #ff0000; display: block; text-align: center; text-decoration: none; }
    .btn-add { background: #28a745; margin-bottom: 5px; }
    .btn-remove { background: #dc3545; }
    #bg {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-position: center; background-repeat: no-repeat;
      background-size: 120%; filter: blur(10px); z-index: -1;
    }
    .passenger-card {
        background: #f9f9f9; border: 1px solid #ddd; border-radius: 10px;
        padding: 20px; margin-bottom: 20px;
    }
    .passenger-card h5 {
        color: #007bff; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;
    }
  </style>
</head>

<body>
  <div id="bg"></div>
  <div class="content-container">
    <h1>Book Your Flight üîñ</h1>
    <div class="alert alert-info">
      Booking Flight <strong>{{flight.flightNumber}}</strong> ({{flight.origin}} &rarr; {{flight.destination}}) on <strong>{{reservedDate}}</strong> for ‚Ç±{{flight.basePrice}} per person.
    </div>

    <form id="reservationForm" action="/reservation-form/create" method="POST">
      <input type="hidden" id="flightId" name="flightId" value="{{flight._id}}"> 
      <input type="hidden" id="reservedDate" name="reservedDate" value="{{reservedDate}}">

      <div id="passengerContainer"></div>

      <div class="row">
        <div class="col-md-6">
            <button type="button" class="btn-action btn-add" id="addPaxBtn">+ Add Another Passenger</button>
        </div>
        <div class="col-md-6">
            <button type="button" class="btn-action btn-remove" id="removePaxBtn">- Remove Last Passenger</button>
        </div>
      </div>

      <hr class="my-4">

      <h4 class="text-center">Select Seats (<span id="seatsSelectedCount">0</span>/<span id="paxDisplay">1</span>)</h4>
      <div class="d-flex justify-content-center mb-2">
          <span class="badge bg-secondary me-2">Occupied</span>
          <span class="badge bg-success me-2">Selected</span>
          <span class="badge" style="background:#e0e0e0; color:#555">Available</span>
      </div>

      <div class="seat-map" id="seatMap"></div>

      <div class="summary-box">
        <h3>Reservation Summary</h3>
        <div id="summaryContent"></div>
        <hr>
        <h4 id="grandTotal">Total: PHP 0</h4>
      </div>

      <input type="hidden" id="totalPriceHidden" name="totalPrice">
      <div id="seatInputsContainer"></div>

      <button type="submit" class="btn-action btn-submit">Confirm Reservation ‚úàÔ∏è</button>
      <a href="/" class="btn-action btn-back">‚¨Ö Back to Flight Search</a>
    </form>
  </div>

   <script>
    const images = [
      "/images/elnido.jpg", "/images/baguio.jpg", "/images/mayon.jpg",
      "/images/ilocos.jpg", "/images/bohol.jpg"
    ];
    const randomImage = images[Math.floor(Math.random() * images.length)];
    document.body.style.background = `url('${randomImage}') no-repeat center center fixed`;
    document.body.style.backgroundSize = "cover";
    document.getElementById("bg").style.background = `url('${randomImage}') center/cover no-repeat fixed`;
  </script>

  <script>
    $(document).ready(function(){
      const baseFare = parseInt("{{flight.basePrice}}" || 5000); 
      const seatCapacity = parseInt("{{flight.seatCapacity}}") || 180;
      
      let paxCount = parseInt("{{pax}}") || 1;
      const occupiedSeats = {{#if occupiedSeats}}{{{occupiedSeats}}}{{else}}[]{{/if}};
      
      let selectedSeats = [];

      const baggageTiers = [
        { weight: 2, cost: 0 }, { weight: 5, cost: 500 },
        { weight: 10, cost: 1000 }, { weight: 15, cost: 1500 },
        { weight: 20, cost: 2000 }
      ];

      function createPassengerForm(index) {
          return `
          <div class="passenger-card" id="pax-card-${index}">
              <h5>Passenger ${index} Details</h5>
              <label>Full Name</label>
              <input type="text" name="fullName" placeholder="Enter full name" required>
              <label>Passport Number</label>
              <input type="text" name="passportNumber" placeholder="Enter passport number" required>
              <label>Meal Option</label>
              <select name="mealOption" class="meal-select" data-index="${index}">
                <option value="0">Chips (PHP 0)</option>
                <option value="150">Mixed Vegetables with Mashed Potato (PHP 150)</option>
                <option value="270">Sausage with Hashbrown (PHP 270)</option>
                <option value="320">Hainanese Soy Chicken with Brown Rice(PHP 320)</option>
                <option value="360">Chives Dumpling with Japanese Gyudon (PHP 360)</option>
              </select>
              <label>Extra Baggage</label>
              <select name="extraBaggage" class="baggage-select" data-index="${index}">
                <option value="2">2 kg (Free)</option>
                <option value="5">5 kg (‚Ç±500)</option>
                <option value="10">10 kg (‚Ç±1,000)</option>
                <option value="15">15 kg (‚Ç±1,500)</option>
                <option value="20">20 kg (‚Ç±2,000)</option>
              </select>
          </div>`;
      }

      function initForms() {
          let html = '';
          for (let i = 1; i <= paxCount; i++) {
              html += createPassengerForm(i);
          }
          $('#passengerContainer').html(html);
          updateUI();
      }

      $('#addPaxBtn').click(function() {
          paxCount++;
          $('#passengerContainer').append(createPassengerForm(paxCount));
          updateUI();
      });

      $('#removePaxBtn').click(function() {
          if (paxCount > 1) {
              $(`#pax-card-${paxCount}`).remove();
              if (selectedSeats.length >= paxCount) {
                  const removedSeat = selectedSeats.pop();
                  $(`.seat[data-seat="${removedSeat}"]`).removeClass('selected');
              }
              paxCount--;
              updateUI();
          } else {
              alert("You must have at least one passenger.");
          }
      });

      function generateSeatMap() {
          $("#seatMap").empty();
          
          let headerHtml = `<div class="d-flex gap-2 mb-2"><div style="width:30px"></div>`;
          ['A','B','C','','D','E','F'].forEach(l => {
              if(l === '') headerHtml += `<div class="aisle-spacer"></div>`;
              else headerHtml += `<div style="width:40px; text-align:center; font-weight:bold;">${l}</div>`;
          });
          headerHtml += `</div>`;
          $("#seatMap").append(headerHtml);

          const rows = Math.ceil(seatCapacity / 6); 
          const cols = ['A', 'B', 'C', 'D', 'E', 'F'];

          for(let r = 1; r <= rows; r++){
              let rowHtml = `<div class="seat-row">`;
              rowHtml += `<div class="aisle-number">${r}</div>`;

              cols.forEach((c, index) => {
                  let seatNum = c + r; 
                  let isOccupied = occupiedSeats.includes(seatNum) ? 'occupied' : '';
                  let isSelected = selectedSeats.includes(seatNum) ? 'selected' : '';
                  
                  if(index === 3) rowHtml += `<div class="aisle-spacer"></div>`;

                  rowHtml += `<div class="seat ${isOccupied} ${isSelected}" data-seat="${seatNum}">${r}${c}</div>`;
              });
              
              rowHtml += `</div>`;
              $("#seatMap").append(rowHtml);
          }
      }

      $(document).on("click", ".seat", function(){
        if($(this).hasClass("occupied")) return;
        const seatNum = $(this).data("seat");

        if ($(this).hasClass("selected")) {
            $(this).removeClass("selected");
            selectedSeats = selectedSeats.filter(s => s !== seatNum);
        } else {
            if (selectedSeats.length < paxCount) {
                $(this).addClass("selected");
                selectedSeats.push(seatNum);
            } else {
                alert(`You have added ${paxCount} passengers. Add another passenger to select more seats.`);
            }
        }
        updateSummary();
      });

      function updateUI() {
          $('#paxDisplay').text(paxCount);
          updateSummary();
      }

      function updateSummary(){
        let grandTotal = 0;
        let summaryHtml = '';
        $('#seatInputsContainer').empty();
        $('#seatsSelectedCount').text(selectedSeats.length);

        $('.passenger-card').each(function(index) {
            let i = index; 
            let mealCost = parseInt($(this).find('.meal-select').val());
            let baggageWeight = parseInt($(this).find('.baggage-select').val());
            let baggageCost = baggageTiers.find(tier => tier.weight === baggageWeight)?.cost || 0;
            let seat = selectedSeats[i] || "None";
            
            let passengerTotal = baseFare + mealCost + baggageCost;
            grandTotal += passengerTotal;

            summaryHtml += `
            <p><strong>Passenger ${i + 1}</strong>: 
               Seat: ${seat}, Meal: ‚Ç±${mealCost}, Bag: ‚Ç±${baggageCost} (${baggageWeight}kg) 
               <br>Subtotal: ‚Ç±${passengerTotal}
            </p>`;

            if (selectedSeats[i]) {
                $('#seatInputsContainer').append(`<input type="hidden" name="selectedSeat" value="${selectedSeats[i]}">`);
            }
        });

        $("#summaryContent").html(summaryHtml);
        $("#grandTotal").text(`Total Amount: PHP ${grandTotal}`);
        $("#totalPriceHidden").val(grandTotal); 
      }

      $(document).on("change keyup", "select, input", updateSummary);
      
      initForms();
      generateSeatMap();

      $("#reservationForm").submit(function(e){
        if (selectedSeats.length !== paxCount) {
            e.preventDefault();
            alert(`You have ${paxCount} passengers but selected ${selectedSeats.length} seats. Please select a seat for everyone.`);
            return false;
        }
        return true; 
      });
    });
  </script>
</body>
</html>